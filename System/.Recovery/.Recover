--[[ 

     _________________________________________________________________________
    |                                                                         |
    |                      RitoOS - ALPHA BUILD -  ^.^                        |
    |                                                                         |
    | - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - |
    |                                                                         |
    |                      Recovery Version Alpha 2.0                         |
    |                                                                         |
    |  - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -  |
    |                                                                         |
    |   Thank you for looking at RitoOS, (or downloading it), it means alot.  |
    |    If you would like to learn more, head on over to the Github page:    |
    |              https://www.github.com/Watsuprico/RitoOS/                  |
    |                                                                         |
    |- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -|
   _|                                                                         |
  |             Some extended info on copying and using RitoOS                |______________________________________________________ 
  |                                                                                                                                 |
  | Permission is hereby granted, free of charge, to any person obtaining a copy of this software and                               |
  | associated documentation files (the "Software"), to deal in the Software without restriction,                                   |
  | including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense,                           |
  | copies of the Software, and to permit persons to whom the Software is furnished to do so,                                       |
  | subject to the following conditions:                                                                                            |
  |                                                                                                                                 |
  | -The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software. |
  | -Visible credit is given to the original author.                                                                                |
  | -The software is distributed in a non-profit way.                                                                               |
  |                                                                                                                                 |
  | THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE            |
  | WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR           |
  | COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,     |
  | ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.                           |
  |                                                                                                                                 |
  |_________________________________________________________________________________________________________________________________|


]]


function PrintCentered(sText)
    local w, h = term.getSize()
    local x, y = term.getCursorPos()
    x = math.max(math.floor((w / 2) - (#sText / 2)), 0)
    term.setCursorPos(x, y)
    print(sText)
end

function CUI(m, head)
  n=1
  l=#m
  while true do
    term.setBackgroundColor(colors.blue)
    term.setTextColor(colors.white)
    term.clear()
    term.setCursorPos(1,1)
    term.setBackgroundColor(colors.cyan)
    term.clearLine()
    PrintCentered(head)
    term.setBackgroundColor(colors.blue)
    print("Please select an option. [arrow up/down]")
    print()
    for i=1, l, 1 do
      if i==n then print(" "..m[i].." - ]\n") else print(" ", m[i], "\n") end
    end
    print()
    a, b= os.pullEventRaw()
    if a == "key" then
      if b==200 and n>1 then n=n-1 end
      if b==208 and n<=l then n=n+1 end
      if b==28 then break end
    end
  end
  term.clear() term.setCursorPos(1,1)
  return n
end


local function Recovery()
  local options={
    "[1] Boot RitoOS",
    "[2] Troubleshoot",
    "[3] Shutdown"
  }
  local n=CUI(options,"RitoOS Recovery")
  if n then
    if n == 1 then
      if fs.exists("/System/.Boot/BN") then
        fs.delete("/System/.Boot/BN")
      end
      os.reboot()
    elseif n == 2 then

        local options={
          "[1] Back",
          "[2] Refresh RitoOS - Reinstall RitoOS and keep your files",
          "[3] Reset RitoOS - Remove all files and reinstall RitoOS",
          "[4] Advance - More options"
        }
        local n=CUI(options,"Troubleshoot")
        
        if n then
          if n == 1 then
            Recovery()
          elseif n == 2 then
            shell.run("/System/.Recovery/.Refresh")
            Recovery()
          elseif n == 3 then
            shell.run("/System/.Recovery/.Reset")
            Recovery()
          elseif n == 4 then

            local options={
              "[1] Back",
              "[2] System Restore - Restore RitoOS from a restore point on a disk",
              "[3] Update Manager - Update or rollback an update",
              "[4] Command Prompt - Use the command prompt",
              "[5] Automatic Repair - Have RitoOS fix it's self",
              "[6] Wipe The Computer - Remove everything"
            }
            local n=CUI(options,"Advance Troubleshooting")
              if n then 
                if n == 1 then
                  Recovery()
                elseif n == 2 then
                  shell.run("/System/.Recovery/.Restore")
                  Recovery()
                elseif n == 3 then
                  shell.run("/System/.Recovery/.UpdateMan")
                  Recovery()
                elseif n == 4 then
                  shell.run("/System/CMD.rxf")
                  sleep(1)
                  Recovery()
                elseif n == 5 then
                  shell.run("/System/.Recovery/.AutomaticRepair")
                  Recovery()
                elseif n == 6 then

                  term.setBackgroundColor(colors.white)
                  term.setTextColor(colors.red)
                  term.clear()
                  term.setCursorPos(1,1)
                  l = 10
                  local c = "" -- Start string
                  for i = 1, l do
                    c = c .. string.char(math.random(33, 126))
                  end
                  print()
                  term.setTextColor(colors.red)
                  print("- This will delete ALL data on this computer -")
                  print("- Please type the 10 character code below to comfirm -")
                  print(c)
                  print()
                  local cc = read()
                  if cc == c then
                    print("/- Good bye -/")
                    for _,file in ipairs(fs.list("/")) do
                      if not fs.isReadOnly(file) then
                        fs.delete(file)
                        print("Deleting "..file)
                      end
                    end
                    print("/- System deleted -/")
                    sleep(5)
                    Recovery()
                  else
                    print("- Code did not match -")
                    print("- Returning -")
                    sleep(3)
                    Recovery()
                  end


                end
              end

          elseif n == 5 then
            Recovery()
          end
        end

    elseif n == 3 then
      os.shutdown()
    elseif n == 4 then
      Recovery()
    end
  end
end

System.logInfo("Recovery","Loaded.")
Recovery()